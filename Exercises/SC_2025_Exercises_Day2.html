<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Single cell course 2025 - Day2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="SC_2025_Exercises_Day2_files/libs/clipboard/clipboard.min.js"></script>
<script src="SC_2025_Exercises_Day2_files/libs/quarto-html/quarto.js"></script>
<script src="SC_2025_Exercises_Day2_files/libs/quarto-html/popper.min.js"></script>
<script src="SC_2025_Exercises_Day2_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="SC_2025_Exercises_Day2_files/libs/quarto-html/anchor.min.js"></script>
<link href="SC_2025_Exercises_Day2_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="SC_2025_Exercises_Day2_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="SC_2025_Exercises_Day2_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="SC_2025_Exercises_Day2_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="SC_2025_Exercises_Day2_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Single cell course 2025 - Day2</h1>
<p class="subtitle lead">Quality Control and Dimnesionality Reduction</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Learning objectives
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Load single cell data into R</li>
<li>Explain the basic structure of a <code>Seurat</code> object and extract count data and metadata</li>
<li>Calculate and visualize quality measures</li>
<li>Perform cell filtering based on quality thresholds</li>
<li>Perform normalization</li>
<li>Identify highly variable features</li>
<li>Perform scaling</li>
<li>Perform linear dimensional reduction and visualize data through UMAP plots</li>
</ul>
</div>
</div>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<section id="data-description" class="level3">
<h3 class="anchored" data-anchor-id="data-description">Data Description:</h3>
<p>The dataset includes Single-cell RNA-sequencing results from 1.3 million peripheral blood mononuclear cells(PBMCs) sourced from 120 individuals. These cells underwent in-vitro stimulation with Mycobacterium tuberculosis (MTB). Sample collection occurred at three different time points: 0 hours, 3 hours, and 24 hours post-stimulation.</p>
<p>For the purpose of this course, we are narrowing our focus to cells from only 8 subjects.</p>
<p>The R package <a href="https://github.com/satijalab/seurat">‘Seurat’</a> is currently the most popular software to do this. The SeuratObject you will be working with is in the files for this course under the name <em>pbmc.MTB</em></p>
<p>To start working with <code>Seurat</code> you can load it into your environment like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Seurat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Other libraries you will need for the exercises:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Load libraries</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BiocSingular)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scDblFinder)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SingleCellExperiment)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scater)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<p>For the following exercises, it is suggested to work with a partner/ in a group so that you can discuss the questions proposed below.</p>
<p>To perform the following exercises please follow <a href="https://satijalab.org/seurat/articles/pbmc3k_tutorial.html">Seurat’s - Guided Clustering Tutorial</a>.</p>
<section id="data-exploration" class="level3">
<h3 class="anchored" data-anchor-id="data-exploration">1. Data Exploration</h3>
<p>Explore the count data and the metadata in the loaded Seurat object.</p>
<p>Load the SeuratObject containing both the count-matrix but also the meta data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Load seurat object</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">#pbmc.MTB &lt;- readRDS("/home/projects/22102_single_cell/day2/pbmc.MTB.rds")</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Loading from andrea's computer</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>pbmc.MTB <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"/Users/andson/Desktop/SingleCell_Course/2025 Course/Datasets/pbmc.MTB.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>a. Check what’s in the <em>pbmc.MTB</em> object, by typing <em>pbmc.MTB</em> in the R console. How many features are in there? And how many cells?</p>
<p>a. Have a look at the <code>data.frame</code> stored at <code>pbmc.MTB@meta.data</code>. What information do you have? How many timepoints are there? How many subjects?</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip:
</div>
</div>
<div class="callout-body-container callout-body">
<p>Both the ‘[[’ and ‘$’ operator allows you to access the metadata variables. There is a subtle difference here between <code>$</code> and <code>[[]]</code>. While <code>$</code> returns a vector of the column in <code>@meta.data</code>, <code>[[]]</code> returns a <code>data.frame</code>.</p>
</div>
</div>
</section>
<section id="quality-control" class="level3">
<h3 class="anchored" data-anchor-id="quality-control">2. Quality Control</h3>
<p>Now that you are more familiar with the Seurat Object, you will perform quality control on the dataset. Seurat allows you to easily explore QC metrics and filter cells based on any defined criteria.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remember some of the commonly used QC metrics are:</p>
<ol type="1">
<li>The number of unique genes detected in each cell.</li>
</ol>
<ul>
<li><p>Low-quality cells or empty droplets will often have very few genes</p></li>
<li><p>Cell doublets or multiplets may exhibit an aberrantly high gene count</p></li>
</ul>
<ol start="2" type="1">
<li><p>The percentage of reads that map to the mitochondrial genome</p>
<ul>
<li>Low-quality/dying cells often have high amounts of mitochondrial reads</li>
</ul></li>
<li><p>Hemoglobin genes</p></li>
<li><p>Ribosomal genes</p></li>
</ol>
</div>
</div>
<p>a. Create QC metrics with the above listed metrics. First calculate the percentage of reads that map to mithocondrial counts and hemoglobin genes and add them to the metadata dataframe.</p>
<div class="callout callout-style-default callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Answer
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Why do damaged cells have a high relative amount of mitochondrial counts?</p></li>
<li><p>Why do you check for hemoglobin genes? Remember you are working with a dataset obtained from PBMCs.</p></li>
</ul>
</div>
</div>
<p>b. Calculate the percentage of counts coming from ribosomal genes</p>
<p>Are not rRNA (ribosomal RNA) but is mRNA that code for ribosomal proteins. They do not point to specific issues, but it can be good to have a look at their relative abundance. They can have biological relevance (e.g.&nbsp;<a href="https://www.nature.com/articles/s41598-020-64929-x">Caron et al.&nbsp;2020</a>).</p>
<p>c. Visualize the created QC metrics as violin plots and perform a visual inspection to decide reasonable cut-offs to filter out contaminated/dying &amp; low-quality cells.</p>
<p>d. Filter the object based on the calculated QC metrics.</p>
<p>e. Plot the average gene-fraction across all cells.</p>
<p>We can also evaluate the relative expression of the genes the that are most highly expressed in our dataset. Some very highly expressed genes might point to a technical cause, and we might consider to remove them. Below you will find a simple function to generate a boxplot of relative counts per gene per cell. Below you will find a function to generate a boxplot of relative counts per gene per cell.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">8</span>, <span class="dv">2</span>, <span class="dv">1</span>))</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>C <span class="ot">&lt;-</span> pbmc.MTB.filtered<span class="sc">@</span>assays<span class="sc">$</span>RNA<span class="sc">@</span>counts</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>C <span class="ot">&lt;-</span> Matrix<span class="sc">::</span><span class="fu">t</span>(Matrix<span class="sc">::</span><span class="fu">t</span>(C)<span class="sc">/</span>Matrix<span class="sc">::</span><span class="fu">colSums</span>(C)) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>most_expressed <span class="ot">&lt;-</span> <span class="fu">order</span>(<span class="fu">apply</span>(C, <span class="dv">1</span>, median), <span class="at">decreasing =</span> T)[<span class="dv">20</span><span class="sc">:</span><span class="dv">1</span>]</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>selected_genes <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">as.matrix</span>(C[most_expressed, ]))</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(<span class="fu">as.matrix</span>(<span class="fu">t</span>(C[most_expressed, ])), <span class="at">cex =</span> <span class="fl">0.1</span>, <span class="at">las =</span> <span class="dv">1</span>, <span class="at">xlab =</span> <span class="st">"% total count per cell"</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> (scales<span class="sc">::</span><span class="fu">hue_pal</span>())(<span class="dv">20</span>)[<span class="dv">20</span><span class="sc">:</span><span class="dv">1</span>], <span class="at">horizontal =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Answer
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Which genes constitute most of the UMIs? Filter them out if deemed necessary.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip:
</div>
</div>
<div class="callout-body-container callout-body">
<p>Look out for MALAT1 and other nuclear lincRNAs. High expression of MALAT1 may indicate contamination or leakage of nuclear RNA into the cytoplasm.As the level of expression of mitochondrial and MALAT1 genes are judged as mainly technical, it can be wise to remove them from the dataset before any further analysis.</p>
<p>OBS: Many researchers choose to remove it, but it can have biological relevance (e.g.&nbsp;<a href="https://www.nature.com/articles/s41420-020-00383-y">Shaat et al.&nbsp;2021</a>).</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>We want to keep as many good quality cells as possible for our analyses. As seen in the box plotted in c, ribosomal genes are relatively abundant in these dataset and might dominate the expression profiles and mask the detection of other biologically relevant transcripts. Instead of removing them directly, we can regress unwanted sources of variation such as mithocondrial and ribosomal genes later in the pipeline (Scaling step).</p>
<p>If mithocondrial/ribosomal reads present any problems in the clustering later in the pipeline you can come back to these first steps and apply a more strict cut-off/filter them out.</p>
</div>
</div>
<p>f. Compare the initial number of cells to the number of cells after performing quality control.</p>
</section>
<section id="normalization" class="level3">
<h3 class="anchored" data-anchor-id="normalization">3. Normalization</h3>
<p>a. Perform a log-normalization following Seurat’s standard workflow. Important to note that Seurat offers another normalization option (SCTranform) which also scales the data but due to the time constriction and for the purpose of performing every step of the pre processing workflow we will use the standard normalization fucntion.</p>
<div class="callout callout-style-default callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Answer
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Why do you normalize the data? How does the Seurat function do it?</p></li>
<li><p>Where is the normalized assay stored?</p></li>
<li><p>Compare the raw data to the normalized data. Did it change?</p></li>
</ul>
</div>
</div>
</section>
<section id="identification-of-highly-variable-features" class="level3">
<h3 class="anchored" data-anchor-id="identification-of-highly-variable-features">4. Identification of Highly Variable Features</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Identifying highly variable features</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>a. Identify the 2000 most variable features in our dataset.</p>
<p>b. Plot a scatter plot to visualize the top 10 highly variable features.</p>
<div class="callout callout-style-default callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Answer
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Why is this step needed?</li>
<li>Think about your dataset, does it make sense that the shown genes are variable across samples?</li>
</ul>
</div>
</div>
<p>Focusing on these genes in downstream analysis helps to highlight biological signal in single-cell datasets</p>
</section>
<section id="scaling" class="level3">
<h3 class="anchored" data-anchor-id="scaling">5. Scaling</h3>
<p>a. Scale the data.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is the step in which if deemed necessary we can regress variables that might dominate the expression profiles and mask the detection of other biologically relevant transcripts.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Regress out ribosomal genes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Answer
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Why do you perform scaling of the data?</li>
</ul>
</div>
</div>
</section>
<section id="visualization" class="level3">
<h3 class="anchored" data-anchor-id="visualization">7. <strong>Visualization</strong></h3>
<p>a. Perform linear dimensionality reduction through a principal component analysis(PCA) on the scaled data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Linear dimention reduction</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>b. Determine the dimensionality of the data. Plot an “elbow plot”/scree plot.</p>
<div class="callout callout-style-default callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Answer
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>What do principal components explain?</li>
<li>How many principal components are responsible for the 80% of the variability in this dataset?</li>
</ul>
</div>
</div>
<p>c. Perform clustering of cells setting the “dims” parameter to the number of PCs that explain 75% of the variance in the dataset. Analyze the plotted scree plot. Could you have decided how many dimensions to include in later steps just by visual assessment of the plot?</p>
<p>d. Determine the K-nearest neighbor graph and determine clusters at resolutions: 0.3, 0.5 and 0.7.</p>
<div class="callout callout-style-default callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Answer
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>How do the functions <em>FindNeighbors</em> and <em>FindClusters</em> work? What is the purpose of each?</li>
</ul>
</div>
</div>
<p>d. Perform a non-linear reduction(UMAP) and plot them using the three different resolutions. Which resolution is the most optimal?</p>
<div class="callout callout-style-default callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Answer
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Which resolution is the most optimal?</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>The optimal resolution depends on your analysis goals. If you’re interested in examining subsets of cells in detail, a higher resolution is preferable. However, for our initial step—cell annotation—we will use the lowest resolution. This approach allows us to separate the major cell groupings without introducing excessive detail within a single cluster.</p>
<p>There is a more objective method to determine the optimal resolution, which we will cover tomorrow.</p>
</div>
</div>
<p>e. Set the chosen resolution as the identity classes of your seurat object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(yourobject) <span class="ot">&lt;-</span> <span class="st">"chosenresolution"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>7. Doublets</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Note:</strong> Doublet detection is not strictly a part of the initial QC and usually performed downstream of the QC (after normalization, PCA and even clustering). However, doublet detection is important and not entirely trivial/standardized part of data processing.</p>
<p>The paper from which the data was retrieved states that the doublets in this dataset were previously removed. But it is always wise to double-check the data when working with datasets obtained from publicly available sources.</p>
</div>
</div>
<p>a. Check for doublets using scDblFinder.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>scDblFinder</strong> works with <em>SingleCellExperiment</em> obejcts. <a href="https://bioconductor.org/packages/release/bioc/html/SingleCellExperiment.html"><code>SingleCellExperiment</code></a>(SCE) is another class for storing single-cell experiment data.</p>
<p>This will be a good opportunity to practice how to convert objects between Seurat and SCE.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Convert your seurat object to a sce object</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Create a sample variable for the doublet predictor to use as input</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>pbmc.MTB.filtered<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">paste0</span>(pbmc.MTB.filtered<span class="sc">$</span>subject, <span class="st">"_"</span>, pbmc.MTB.filtered<span class="sc">$</span>timepoint)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>sce <span class="ot">&lt;-</span> <span class="fu">as.SingleCellExperiment</span>(pbmc.MTB.filtered)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Store the highly variable features as top.var (required to use with scDblFinder)</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>top.var <span class="ot">&lt;-</span> <span class="fu">VariableFeatures</span>(pbmc.MTB.filtered)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>b. Visualize the calculated doublet predictions</p>
<div class="callout callout-style-default callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Answer
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>How does the <em>scDblFinder</em> work?</li>
<li>What percentage of the dataset was deemed as doublets?</li>
</ul>
</div>
</div>
<p>c. Analyze the UMAP created in task 7d. Are there cells that are shared beteen/are in more than one of the formed “clusters”? Can these be doublets?</p>
<p>Lastly, save your Seurat object for the day as we will continue working with it tomorrow.</p>
<div class="callout callout-style-simple callout-caution no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>Before you leave:</p>
<p>Make sure you know where the following are stored/how to access them in your object:</p>
<ol type="1">
<li>Raw counts &amp; Metadata</li>
<li>Normalized Data</li>
<li>Scaled Data</li>
<li>Variable genes</li>
<li>Graphs used for clustering</li>
<li>PCA &amp; UMAP</li>
</ol>
</div>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>